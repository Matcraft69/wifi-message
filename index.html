<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Wi-Fi - Version Survie</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background: #f4f4f9; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); max-width: 400px; margin: auto; }
        .id-display { font-size: 35px; font-weight: bold; color: #007bff; background: #eef2ff; padding: 15px; border-radius: 10px; margin: 15px 0; border: 2px dashed #007bff; }
        #chat { height: 250px; border: 1px solid #ddd; overflow-y: auto; margin: 15px 0; padding: 10px; background: #fff; border-radius: 8px; text-align: left; }
        input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .status { font-size: 12px; color: #666; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="card">
    <h2>Messagerie Directe</h2>
    <div id="setup">
        <div class="status" id="status">Statut : Connexion au serveur...</div>
        <div id="my-id" class="id-display">....</div>
        <button onclick="location.reload()" style="background:#6c757d; margin-bottom:20px; font-size:12px; width:auto; padding:5px 10px;">ðŸ”„ RÃ©essayer</button>
        
        <input type="text" id="peer-id" placeholder="Code de l'ami">
        <button onclick="connecter()">SE CONNECTER</button>
    </div>

    <div id="chat-box" style="display:none;">
        <div id="chat"></div>
        <input type="text" id="message" placeholder="Message...">
        <button onclick="envoyer()">ENVOYER</button>
    </div>
</div>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
    // On gÃ©nÃ¨re un ID
    const monId = Math.floor(1000 + Math.random() * 9000).toString();
    
    // On change de serveur pour essayer de contourner l'erreur rÃ©seau
    let peer = new Peer(monId);

    peer.on('open', (id) => {
        document.getElementById('my-id').innerText = id;
        document.getElementById('status').innerText = "âœ… PrÃªt ! Partage ton code.";
        document.getElementById('status').style.color = "green";
    });

    peer.on('error', (err) => {
        console.error("Erreur dÃ©tectÃ©e :", err.type);
        document.getElementById('status').innerText = "âŒ Erreur : " + err.type;
        document.getElementById('status').style.color = "red";
        
        if(err.type === 'network') {
            document.getElementById('my-id').innerText = "BLOQUÃ‰";
            alert("Le rÃ©seau bloque la connexion. Essaie de dÃ©sactiver le Wi-Fi et d'utiliser la 4G/5G.");
        }
    });

    peer.on('connection', (c) => {
        conn = c;
        setupChat();
    });

    function connecter() {
        const idAmi = document.getElementById('peer-id').value;
        if (!idAmi) return alert("Code vide");
        conn = peer.connect(idAmi);
        setupChat();
    }

    function setupChat() {
        document.getElementById('setup').style.display = 'none';
        document.getElementById('chat-box').style.display = 'block';
        conn.on('data', (data) => {
            document.getElementById('chat').innerHTML += `<div><b>Ami :</b> ${data}</div>`;
        });
    }

    function envoyer() {
        const i = document.getElementById('message');
        if(i.value && conn) {
            conn.send(i.value);
            document.getElementById('chat').innerHTML += `<div style="color:blue"><b>Moi :</b> ${i.value}</div>`;
            i.value = "";
        }
    }
</script>
</body>
</html>
