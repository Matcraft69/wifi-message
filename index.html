<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeoChat P2P</title>
    <style>
        :root { --p: #007AFF; --bg: #f2f2f7; --card: rgba(255, 255, 255, 0.8); --text: #1c1c1e; }
        .dark-mode { --bg: #000000; --card: rgba(28, 28, 30, 0.8); --text: #ffffff; }
        
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); color: var(--text); margin: 0; transition: 0.4s; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        .app-container { width: 100%; max-width: 420px; height: 95vh; background: var(--card); backdrop-filter: blur(20px); border-radius: 30px; display: flex; flex-direction: column; box-shadow: 0 20px 50px rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); position: relative; }
        
        /* Header */
        header { padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #ff3b30; display: inline-block; margin-right: 5px; }
        .online { background: #34c759; }

        /* Chat Zone */
        #chat { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .bubble { padding: 10px 15px; border-radius: 18px; max-width: 80%; font-size: 15px; line-height: 1.4; position: relative; }
        .moi { align-self: flex-end; background: var(--p); color: white; border-bottom-right-radius: 4px; }
        .ami { align-self: flex-start; background: #e9e9eb; color: #000; border-bottom-left-radius: 4px; }
        .vocal-msg { display: flex; align-items: center; gap: 10px; }

        /* Mini-Dessin R√©tractable */
        #draw-panel { height: 0; overflow: hidden; transition: 0.3s; background: #fff; }
        #draw-panel.open { height: 150px; border-bottom: 1px solid #ddd; }
        canvas { width: 100%; height: 120px; touch-action: none; }

        /* Morpion Overlay */
        #game-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.8); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 100; border-radius: 30px; color: white; }
        .grid { display: grid; grid-template-columns: repeat(3, 80px); gap: 10px; }
        .cell { width: 80px; height: 80px; background: rgba(255,255,255,0.1); border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 30px; font-weight: bold; cursor: pointer; }

        /* Controls */
        .input-area { padding: 15px; display: flex; gap: 10px; align-items: center; }
        input[type="text"] { flex: 1; padding: 12px; border-radius: 20px; border: none; background: rgba(0,0,0,0.05); color: var(--text); outline: none; }
        .btn-round { width: 40px; height: 40px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .btn-vocal.rec { background: #ff3b30; animation: pulse 1s infinite; }

        /* Settings Modal */
        #settings { display: none; position: absolute; top: 70px; right: 20px; background: var(--card); padding: 15px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 50; }
    </style>
</head>
<body>

<div class="app-container" id="app">
    <header>
        <div><span id="dot" class="status-dot"></span> <b id="user-title">NeoChat</b></div>
        <div style="display:flex; gap:10px;">
            <button class="btn-round" onclick="document.getElementById('draw-panel').classList.toggle('open')">üé®</button>
            <button class="btn-round" onclick="inviteJeu()">üéÆ</button>
            <button class="btn-round" onclick="toggleSettings()">‚öôÔ∏è</button>
        </div>
    </header>

    <div id="draw-panel">
        <canvas id="canvas"></canvas>
        <button onclick="clearCanvas()" style="width:100%; font-size:10px;">Effacer</button>
    </div>

    <div id="game-overlay">
        <h2 id="game-status">Morpion</h2>
        <div class="grid" id="board"></div>
        <button onclick="closeGame()" style="margin-top:20px; background:#ff3b30; padding:10px 20px; border-radius:10px;">Quitter</button>
    </div>

    <div id="chat">
        <div class="bubble ami">Bienvenue ! Partage ton code pour commencer.</div>
    </div>

    <div id="settings">
        <input type="text" id="set-name" placeholder="Ton Pseudo" style="width:100px"><br><br>
        <button onclick="toggleDarkMode()" style="width:100%">Mode Sombre</button><br><br>
        <button onclick="alert('Historique effac√©'); location.reload()" style="color:red">R√©initialiser</button>
    </div>

    <div id="setup-screen" style="padding:20px; text-align:center;">
        <h1 id="my-id" style="font-size:40px; color:var(--p); margin:10px 0;">----</h1>
        <input type="text" id="peer-id" placeholder="Code ami" style="width:80%; margin-bottom:10px;"><br>
        <button onclick="connecter()" style="width:85%; background:var(--p); padding:15px; border-radius:15px;">SE CONNECTER</button>
    </div>

    <div class="input-area" id="controls" style="display:none">
        <button class="btn-round" onclick="document.getElementById('file-input').click()">‚ûï</button>
        <input type="text" id="msg-input" placeholder="Message...">
        <button id="vocal-btn" class="btn-round" style="background:#5856d6">üé§</button>
        <button class="btn-round" onclick="sendMsg()" style="background:var(--p)">‚Üë</button>
        <input type="file" id="file-input" hidden onchange="sendImg(this)">
    </div>
</div>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
    const monId = Math.floor(1000 + Math.random() * 9000).toString();
    const peer = new Peer(monId);
    let conn, mediaRecorder, chunks = [], myName = "Moi", friendName = "Ami";

    peer.on('open', id => document.getElementById('my-id').innerText = id);
    peer.on('connection', c => { conn = c; initChat(); });

    function connecter() {
        conn = peer.connect(document.getElementById('peer-id').value);
        initChat();
    }

    function initChat() {
        document.getElementById('setup-screen').style.display = 'none';
        document.getElementById('controls').style.display = 'flex';
        document.getElementById('dot').classList.add('online');
        
        conn.on('data', data => {
            if(data.type === 'vocal') addVocal(data.content, 'ami');
            else if(data.type === 'draw') renderDraw(data);
            else if(data.type === 'game-invite') { if(confirm("Pr√™t pour un Morpion ?")) { conn.send({type:'game-start'}); startGame(); } }
            else if(data.type === 'game-start') startGame();
            else if(data.type === 'game-move') updateGame(data.idx, 'O');
            else addBubble(data, 'ami');
        });
    }

    // --- CHAT & VOCAL ---
    function addBubble(content, type) {
        const chat = document.getElementById('chat');
        chat.innerHTML += `<div class="bubble ${type}">${content}</div>`;
        chat.scrollTop = chat.scrollHeight;
    }

    function addVocal(url, type) {
        const chat = document.getElementById('chat');
        const id = 'v-' + Date.now();
        chat.innerHTML += `<div class="bubble ${type} vocal-msg">
            <button onclick="document.getElementById('${id}').play()" style="background:none; border:none; font-size:20px;">‚ñ∂Ô∏è</button>
            <span>Audio</span>
            <audio id="${id}" src="${url}"></audio>
        </div>`;
        chat.scrollTop = chat.scrollHeight;
    }

    // --- ENREGISTREMENT VOCAL ---
    navigator.mediaDevices.getUserMedia({ audio: true }).then(s => {
        mediaRecorder = new MediaRecorder(s);
        mediaRecorder.ondataavailable = e => chunks.push(e.data);
        mediaRecorder.onstop = () => {
            const blob = new Blob(chunks, { type: 'audio/ogg' });
            const reader = new FileReader();
            reader.onload = () => {
                conn.send({type:'vocal', content: reader.result});
                addVocal(reader.result, 'moi');
            };
            reader.readAsDataURL(blob);
            chunks = [];
        };
    });

    const vBtn = document.getElementById('vocal-btn');
    vBtn.onmousedown = vBtn.ontouchstart = () => { vBtn.classList.add('rec'); mediaRecorder.start(); };
    vBtn.onmouseup = vBtn.ontouchend = () => { vBtn.classList.remove('rec'); mediaRecorder.stop(); };

    // --- JEU MORPION ---
    let cells = Array(9).fill(null);
    function inviteJeu() { conn.send({type:'game-invite'}); }
    function startGame() {
        document.getElementById('game-overlay').style.display = 'flex';
        const board = document.getElementById('board');
        board.innerHTML = ''; cells.fill(null);
        for(let i=0; i<9; i++) {
            let c = document.createElement('div'); c.className = 'cell';
            c.onclick = () => {
                if(!cells[i]) {
                    cells[i] = 'X'; c.innerText = 'X';
                    conn.send({type:'game-move', idx: i});
                    checkWin();
                }
            };
            board.appendChild(c);
        }
    }

    function updateGame(idx, symbol) {
        cells[idx] = symbol;
        document.querySelectorAll('.cell')[idx].innerText = symbol;
        checkWin();
    }

    function checkWin() {
        const lines = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
        for(let l of lines) {
            const [a,b,c] = l;
            if(cells[a] && cells[a] === cells[b] && cells[a] === cells[c]) {
                alert(cells[a] === 'X' ? "TU AS GAGN√â ! üèÜ" : "TU AS PERDU... üíÄ");
                return closeGame();
            }
        }
        if(!cells.includes(null)) { alert("MATCH NUL ! ü§ù"); closeGame(); }
    }

    function closeGame() { document.getElementById('game-overlay').style.display = 'none'; }

    // --- DESSIN ---
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let isDrawing = false;
    canvas.onmousedown = canvas.ontouchstart = (e) => { isDrawing = true; ctx.beginPath(); };
    canvas.onmousemove = canvas.ontouchmove = (e) => {
        if(!isDrawing) return;
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX || e.touches[0].clientX) - rect.left;
        const y = (e.clientY || e.touches[0].clientY) - rect.top;
        ctx.lineTo(x, y); ctx.stroke();
        conn.send({type:'draw', x, y});
    };
    window.onmouseup = window.ontouchend = () => { isDrawing = false; };
    function renderDraw(d) { ctx.lineTo(d.x, d.y); ctx.stroke(); }
    function clearCanvas() { ctx.clearRect(0,0,500,500); }

    // --- UTILITAIRES ---
    function sendMsg() { 
        const i = document.getElementById('msg-input'); 
        if(i.value) { conn.send(i.value); addBubble(i.value, 'moi'); i.value = ""; }
    }
    function toggleSettings() { 
        const s = document.getElementById('settings');
        s.style.display = s.style.display === 'block' ? 'none' : 'block';
    }
    function toggleDarkMode() { document.body.classList.toggle('dark-mode'); }
</script>
</body>
</html>
