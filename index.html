<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NeoChat - Modif & Suppr</title>
    <style>
        :root { --p: #007AFF; --bg: #f2f2f7; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }
        #chat { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        
        .bubble { padding: 10px 15px; border-radius: 18px; max-width: 80%; font-size: 15px; position: relative; transition: 0.2s; user-select: none; -webkit-user-select: none; }
        .moi { align-self: flex-end; background: var(--p); color: white; cursor: pointer; }
        .ami { align-self: flex-start; background: #e9e9eb; color: black; }
        
        .bar { padding: 10px; background: white; border-top: 1px solid #ddd; display: flex; gap: 10px; }
        input { flex: 1; padding: 10px; border-radius: 20px; border: 1px solid #ddd; outline: none; }
        
        /* Menu contextuel */
        #menu { display: none; position: fixed; background: white; border-radius: 12px; shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 1000; overflow: hidden; border: 1px solid #ddd; }
        #menu button { display: block; width: 100%; padding: 12px 20px; border: none; background: white; font-size: 14px; cursor: pointer; border-bottom: 1px solid #eee; }
        #menu button:last-child { color: red; border: none; }
        #menu button:active { background: #f0f0f0; }

        #setup { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div id="setup">
    <h1 id="my-id" style="font-size: 40px; color: var(--p);">....</h1>
    <input type="text" id="peer-id" placeholder="Code ami" style="width:60%; margin-bottom:10px;">
    <button onclick="connecter()" style="background:var(--p); color:white; border:none; padding:12px 25px; border-radius:10px;">REJOINDRE</button>
</div>

<div id="chat"></div>

<div id="menu">
    <button onclick="demanderModif()">Modifier</button>
    <button onclick="demanderSuppr()">Supprimer</button>
    <button onclick="fermerMenu()">Annuler</button>
</div>

<div class="bar" id="controls" style="visibility:hidden">
    <input type="text" id="msg-in" placeholder="Message...">
    <button onclick="envoyer()" style="background:var(--p); color:white; border:none; border-radius:50%; width:40px; height:40px;">â†‘</button>
</div>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
    const myId = Math.floor(1000 + Math.random() * 9000).toString();
    const peer = new Peer(myId);
    let conn, msgCible = null, longPressTimer;

    peer.on('open', id => document.getElementById('my-id').innerText = id);
    peer.on('connection', c => { conn = c; init(); });

    function connecter() {
        conn = peer.connect(document.getElementById('peer-id').value);
        init();
    }

    function init() {
        document.getElementById('setup').style.display = 'none';
        document.getElementById('controls').style.visibility = 'visible';
        conn.on('data', d => {
            if(d.type === 'edit') document.getElementById(d.id).innerText = d.txt;
            else if(d.type === 'del') document.getElementById(d.id).remove();
            else addMsg(d.txt, 'ami', d.id);
        });
    }

    function envoyer() {
        const i = document.getElementById('msg-in');
        if(!i.value) return;
        const id = 'm-' + Date.now();
        conn.send({type:'msg', txt: i.value, id: id});
        addMsg(i.value, 'moi', id);
        i.value = "";
    }

    function addMsg(txt, type, id) {
        const div = document.createElement('div');
        div.id = id;
        div.className = `bubble ${type}`;
        div.innerText = txt;
        
        // Clic long (Mobile & Desktop)
        if(type === 'moi') {
            div.onmousedown = div.ontouchstart = (e) => {
                longPressTimer = setTimeout(() => ouvrirMenu(e, id), 600);
            };
            div.onmouseup = div.ontouchend = () => clearTimeout(longPressTimer);
        }

        document.getElementById('chat').appendChild(div);
        document.getElementById('chat').scrollTop = document.getElementById('chat').scrollHeight;
    }

    function ouvrirMenu(e, id) {
        msgCible = id;
        const menu = document.getElementById('menu');
        menu.style.display = 'block';
        const x = (e.clientX || (e.touches && e.touches[0].clientX)) || 100;
        const y = (e.clientY || (e.touches && e.touches[0].clientY)) || 100;
        menu.style.left = x + 'px';
        menu.style.top = y + 'px';
    }

    function demanderModif() {
        const el = document.getElementById(msgCible);
        const nvx = prompt("Modifier le message :", el.innerText);
        if(nvx) {
            el.innerText = nvx;
            conn.send({type:'edit', id: msgCible, txt: nvx});
        }
        fermerMenu();
    }

    function demanderSuppr() {
        if(confirm("Supprimer ce message ?")) {
            document.getElementById(msgCible).remove();
            conn.send({type:'del', id: msgCible});
        }
        fermerMenu();
    }

    function fermerMenu() { document.getElementById('menu').style.display = 'none'; }
</script>
</body>
</html>
