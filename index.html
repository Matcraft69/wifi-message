<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NeoChat Luxe</title>
    <style>
        :root { --p: #007AFF; --bg: #f2f2f7; --card: rgba(255, 255, 255, 0.7); --text: #1c1c1e; --blur: blur(25px); }
        .dark-mode { --bg: #000; --card: rgba(30, 30, 30, 0.7); --text: #fff; }
        
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; height: 100dvh; display: flex; justify-content: center; transition: 0.4s; overflow: hidden; }
        .app { width: 100%; max-width: 500px; display: flex; flex-direction: column; background: var(--card); backdrop-filter: var(--blur); -webkit-backdrop-filter: var(--blur); position: relative; }

        /* Header Moderne */
        header { padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 0.5px solid rgba(128,128,128,0.2); }
        .dot { width: 12px; height: 12px; border-radius: 50%; background: #ff3b30; transition: 0.3s; }
        .online { background: #34c759; box-shadow: 0 0 10px #34c759; }

        /* Zone de Chat */
        #chat { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; scroll-behavior: smooth; }
        .bubble { padding: 12px 16px; border-radius: 20px; max-width: 75%; font-size: 15px; animation: slideIn 0.3s ease-out; word-wrap: break-word; }
        .moi { align-self: flex-end; background: var(--p); color: white; border-bottom-right-radius: 4px; }
        .ami { align-self: flex-start; background: rgba(128,128,128,0.15); border-bottom-left-radius: 4px; }
        
        /* Panneaux R√©tractables */
        .panel { height: 0; overflow: hidden; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); background: rgba(0,0,0,0.03); }
        .panel.open { height: 180px; border-bottom: 0.5px solid rgba(128,128,128,0.2); }
        canvas { width: 100%; height: 140px; touch-action: none; }

        /* Morpion Minimaliste */
        #game-view { position: absolute; inset: 0; background: var(--bg); z-index: 100; display: none; flex-direction: column; align-items: center; justify-content: center; animation: fadeIn 0.4s; }
        .grid { display: grid; grid-template-columns: repeat(3, 90px); gap: 12px; }
        .cell { width: 90px; height: 90px; background: rgba(128,128,128,0.1); border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 35px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .cell:active { transform: scale(0.9); }

        /* Input Bar */
        .bar { padding: 15px; display: flex; gap: 10px; align-items: center; background: transparent; }
        .input-group { flex: 1; background: rgba(128,128,128,0.1); border-radius: 25px; display: flex; align-items: center; padding: 2px 15px; }
        input[type="text"] { flex: 1; border: none; background: transparent; padding: 10px; color: var(--text); outline: none; }
        
        .btn { width: 42px; height: 42px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; transition: 0.3s; }
        .btn-p { background: var(--p); color: white; }
        .rec { background: #ff3b30 !important; animation: pulse 1s infinite; }

        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

<div class="app">
    <header>
        <div style="display:flex; align-items:center; gap:10px;">
            <div id="dot" class="dot"></div>
            <b id="status-txt">D√©connect√©</b>
        </div>
        <div style="display:flex; gap:8px;">
            <button class="btn" onclick="togglePanel('draw-panel')">üé®</button>
            <button class="btn" onclick="inviteGame()">üéÆ</button>
            <button class="btn" onclick="toggleDarkMode()">üåì</button>
        </div>
    </header>

    <div id="draw-panel" class="panel">
        <canvas id="canvas"></canvas>
        <div style="display:flex; justify-content: space-around; padding: 5px;">
            <button onclick="clearCanvas()" style="background:none; border:none; color:var(--p)">Effacer</button>
            <input type="color" id="draw-color" value="#007AFF">
        </div>
    </div>

    <div id="game-view">
        <h2 id="game-msg">Morpion</h2>
        <div class="grid" id="board"></div>
        <button onclick="closeGame()" style="margin-top:30px; background:none; border:none; color:#ff3b30; font-weight:bold;">QUITTER</button>
    </div>

    <div id="chat">
        <div id="setup" style="text-align:center; padding-top:50px;">
            <h1 id="my-id" style="font-size:45px; letter-spacing:8px; color:var(--p);">----</h1>
            <p>Ton Code NeoChat</p>
            <input type="text" id="peer-id" placeholder="Code ami" style="width:70%; background:rgba(128,128,128,0.1); border-radius:15px; margin-bottom:15px;">
            <button class="btn-p" onclick="connecter()" style="width:75%; height:50px; border-radius:15px; margin:auto;">REJOINDRE</button>
        </div>
    </div>

    <div class="bar" id="controls" style="display:none">
        <button class="btn" onclick="document.getElementById('file').click()">üñºÔ∏è</button>
        <div class="input-group">
            <input type="text" id="msg-in" placeholder="Message...">
            <button id="vocal-btn" style="background:none; border:none; font-size:20px;">üé§</button>
        </div>
        <button class="btn btn-p" onclick="send()">‚Üë</button>
        <input type="file" id="file" hidden onchange="sendImg(this)" accept="image/*">
    </div>
</div>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
    const myId = Math.floor(1000 + Math.random() * 9000).toString();
    const peer = new Peer(myId);
    let conn, mediaRecorder, chunks = [];

    peer.on('open', id => document.getElementById('my-id').innerText = id);
    peer.on('connection', c => { conn = c; start(); });

    function connecter() {
        conn = peer.connect(document.getElementById('peer-id').value);
        start();
    }

    function start() {
        document.getElementById('setup').style.display = 'none';
        document.getElementById('controls').style.display = 'flex';
        document.getElementById('dot').classList.add('online');
        document.getElementById('status-txt').innerText = "En ligne";

        conn.on('data', d => {
            if(d.type === 'v') addVocal(d.c, 'ami');
            else if(d.type === 'd') renderDraw(d);
            else if(d.type === 'g-inv') { if(confirm("Partie de Morpion ?")) { conn.send({type:'g-ok'}); runGame(); } }
            else if(d.type === 'g-ok') runGame();
            else if(d.type === 'g-mv') updateBoard(d.i, 'O');
            else addMsg(d, 'ami');
        });
    }

    // --- MESSAGERIE & VOCAL ---
    function addMsg(c, t) {
        const h = document.getElementById('chat');
        h.innerHTML += `<div class="bubble ${t}">${c}</div>`;
        h.scrollTop = h.scrollHeight;
    }

    function addVocal(url, t) {
        const h = document.getElementById('chat');
        const id = 'v'+Date.now();
        h.innerHTML += `<div class="bubble ${t}">
            <button onclick="document.getElementById('${id}').play()" style="background:none; border:none; color:inherit; font-size:18px; cursor:pointer;">‚ñ∂Ô∏è R√â√âCOUTER</button>
            <audio id="${id}" src="${url}"></audio>
        </div>`;
        h.scrollTop = h.scrollHeight;
    }

    navigator.mediaDevices.getUserMedia({ audio: true }).then(s => {
        mediaRecorder = new MediaRecorder(s);
        mediaRecorder.ondataavailable = e => chunks.push(e.data);
        mediaRecorder.onstop = () => {
            const reader = new FileReader();
            reader.onload = () => {
                conn.send({type:'v', c: reader.result});
                addVocal(reader.result, 'moi');
            };
            reader.readAsDataURL(new Blob(chunks));
            chunks = [];
        };
    });

    const vBtn = document.getElementById('vocal-btn');
    vBtn.onmousedown = vBtn.ontouchstart = () => { vBtn.parentElement.classList.add('rec'); mediaRecorder.start(); };
    vBtn.onmouseup = vBtn.ontouchend = () => { vBtn.parentElement.classList.remove('rec'); mediaRecorder.stop(); };

    // --- MORPION OPTIMIS√â ---
    let b = Array(9).fill(null);
    function inviteGame() { conn.send({type:'g-inv'}); alert("Invitation envoy√©e !"); }
    function runGame() {
        document.getElementById('game-view').style.display = 'flex';
        const g = document.getElementById('board');
        g.innerHTML = ''; b.fill(null);
        for(let i=0; i<9; i++) {
            let c = document.createElement('div'); c.className = 'cell';
            c.onclick = () => {
                if(!b[i]) {
                    b[i] = 'X'; c.innerText = 'X'; c.style.color = 'var(--p)';
                    conn.send({type:'g-mv', i: i});
                    check();
                }
            };
            g.appendChild(c);
        }
    }
    function updateBoard(i, s) {
        b[i] = s;
        const c = document.querySelectorAll('.cell')[i];
        c.innerText = s; c.style.color = '#ff3b30';
        check();
    }
    function check() {
        const w = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
        for(let q of w) {
            const [x,y,z] = q;
            if(b[x] && b[x]===b[y] && b[x]===b[z]) {
                document.getElementById('game-msg').innerText = b[x]==='X' ? "VICTOIRE ! üèÜ" : "D√âFAITE... üíÄ";
                setTimeout(closeGame, 2000); return;
            }
        }
        if(!b.includes(null)) { document.getElementById('game-msg').innerText = "NUL ! ü§ù"; setTimeout(closeGame, 2000); }
    }
    function closeGame() { document.getElementById('game-view').style.display='none'; document.getElementById('game-msg').innerText="Morpion"; }

    // --- DESSIN FLUIDE ---
    const cv = document.getElementById('canvas');
    const cx = cv.getContext('2d');
    let dr = false;
    function togglePanel(id) { 
        const p = document.getElementById(id); 
        p.classList.toggle('open'); 
        if(p.classList.contains('open')) { cv.width = cv.offsetWidth; cv.height = 140; cx.lineCap='round'; cx.lineWidth=3; }
    }
    cv.onmousedown = cv.ontouchstart = () => { dr = true; cx.beginPath(); };
    cv.onmousemove = cv.ontouchmove = (e) => {
        if(!dr) return;
        const r = cv.getBoundingClientRect();
        const x = (e.clientX || e.touches[0].clientX) - r.left;
        const y = (e.clientY || e.touches[0].clientY) - r.top;
        const co = document.getElementById('draw-color').value;
        cx.strokeStyle = co; cx.lineTo(x, y); cx.stroke();
        conn.send({type:'d', x, y, co});
    };
    window.onmouseup = window.ontouchend = () => { dr = false; };
    function renderDraw(d) { cx.strokeStyle = d.co; cx.lineTo(d.x, d.y); cx.stroke(); }
    function clearCanvas() { cx.clearRect(0,0,cv.width,cv.height); }

    // --- SYST√àME ---
    function send() { 
        const i = document.getElementById('msg-in'); 
        if(i.value) { conn.send(i.value); addMsg(i.value, 'moi'); i.value = ""; }
    }
    function toggleDarkMode() { document.body.classList.toggle('dark-mode'); }
    function sendImg(input) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = e => {
            conn.send(i.value); // Pour la coh√©rence on peut aussi envoyer des objets
            addMsg(`<img src="${e.target.result}" style="width:100%; border-radius:10px;">`, 'moi');
            conn.send(`<img src="${e.target.result}" style="width:100%; border-radius:10px;">`);
        };
        reader.readAsDataURL(file);
    }
</script>
</body>
</html>
